#!/usr/bin/env zsh
set -ue

list() {
  cat "$HOME/.projects"
}

build() {
  trap "rm -f $HOME/.projects.$$" EXIT

  printf "$CODE_ROOT\n" | tee "$HOME/.projects.$$"
  printf "$DOTFILES\n" | tee -a "$HOME/.projects.$$"

  find "$CODE_ROOT" -maxdepth 2 -mindepth 1 -type d -name '.git' | while read repository; do
    dirname "$repository" | tee -a "$HOME/.projects.$$"
  done

  mv "$HOME/.projects.$$" "$HOME/.projects"
}

guess() {
  projects=$(list | xargs -n 1 basename)
  match=$(printf "$projects" | matcher "$1" --limit 1)

  list | ag "$match$"
}

new() {
  git init "$CODE_ROOT/$1" > /dev/null

  printf "$CODE_ROOT/$1\n"
  build &>/dev/null & # rebuild the list
}

if [[ "$#" > 0 ]]; then
  command="$1"

  shift
else
  command="list"
fi

case "$command" in
  "build") build $* ;;
  "guess") guess $* ;;
  "list") list $* ;;
  "new") new $* ;;
  *) printf "wtf are you doing\n" 1>&2 ;;
esac
